<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Â±ÄÂüüÁΩëËÅäÂ§©ÂÆ§</title>
    <script src="https://res.gemcoder.com/js/reload.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1677ff',
                        secondary: '#6b7280',
                        accent: '#36bffa',
                        success: '#00b42a',
                        warning: '#ff7d00',
                        danger: '#f53f3f',
                        light: '#f2f3f5',
                        dark: '#1d2129'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-custom { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        }
        /* Custom scrollbar for message container only */
        #messageContainer::-webkit-scrollbar {
            width: 6px;
        }
        #messageContainer::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        #messageContainer::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 3px;
        }
        #messageContainer::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="font-inter bg-gray-100 h-screen flex items-center justify-center overflow-hidden">
    <div class="w-full h-full max-w-[1440px] bg-white shadow-2xl flex overflow-hidden relative">
        
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-200 flex flex-col h-full hidden md:flex">
            <div class="p-3 border-b border-gray-200">
                <div class="relative">
                    <input class="w-full py-2 pl-10 pr-4 rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="ÊêúÁ¥¢ËÅäÂ§©..." type="text"/>
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto" id="userList">
                <!-- User list will be populated by JS -->
            </div>
            <div class="p-3 border-t border-gray-200">
                <div class="flex items-center">
                    <img src="/api/searchImage?query={{ nickname }}" class="w-8 h-8 rounded-full"/>
                    <span class="ml-2 text-sm font-medium truncate">{{ nickname }}</span>
                    <a href="/" class="ml-auto text-gray-400 hover:text-danger"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col bg-gray-50 w-full">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 p-3 flex items-center justify-between">
                <div class="flex items-center">
                    <button class="md:hidden mr-2 text-gray-500">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img alt="Group" class="w-10 h-10 rounded-full object-cover" src="/api/searchImage?query=Group"/>
                    <div class="ml-3">
                        <h3 class="font-medium">ÂÖ¨ÂÖ±ËÅäÂ§©ÂÆ§</h3>
                        <p class="text-xs text-green-500"><span id="onlineCount">1</span> ‰∫∫Âú®Á∫ø</p>
                    </div>
                </div>
                <div class="flex space-x-3 text-gray-500">
                    <button class="hover:text-primary transition-custom" title="ÂéÜÂè≤ËÆ∞ÂΩï" onclick="alert('ÂéÜÂè≤ËÆ∞ÂΩïÂäüËÉΩÊ≠£Âú®Âª∫ËÆæ‰∏≠...')"><i class="fas fa-history"></i></button>
                </div>
            </div>

            <!-- Messages -->
            <div class="flex-1 p-4 overflow-y-auto" id="messageContainer">
                <!-- Messages will be appended here -->
            </div>

            <!-- Input Area -->
            <div class="bg-white border-t border-gray-200 p-3 relative">
                <div class="flex items-center mb-2 text-gray-500 space-x-2">
                    <button class="hover:text-primary transition-custom p-1" onclick="insertText('@Èü≥‰πê ')"><span class="text-xs bg-gray-100 px-2 py-1 rounded">@Èü≥‰πê</span></button>
                    <button class="hover:text-primary transition-custom p-1" onclick="insertText('@ÁîµÂΩ± ')"><span class="text-xs bg-gray-100 px-2 py-1 rounded">@ÁîµÂΩ±</span></button>
                    <button class="hover:text-primary transition-custom p-1" onclick="insertText('@Â§©Ê∞î ')"><span class="text-xs bg-gray-100 px-2 py-1 rounded">@Â§©Ê∞î</span></button>
                    <button class="hover:text-primary transition-custom p-1" onclick="insertText('@Êñ∞Èóª ')"><span class="text-xs bg-gray-100 px-2 py-1 rounded">@Êñ∞Èóª</span></button>
                    <button class="hover:text-primary transition-custom p-1" onclick="insertText('@ÊàêÂ∞èÁêÜ ')"><span class="text-xs bg-gray-100 px-2 py-1 rounded">@ÊàêÂ∞èÁêÜ</span></button>
                    
                    <div class="relative">
                        <button id="emojiBtn" class="hover:text-primary transition-custom p-1 text-lg">üòÄ</button>
                        <!-- Emoji Picker -->
                        <div id="emojiPicker" class="hidden absolute bottom-full right-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg p-2 w-64 h-48 overflow-y-auto z-50">
                            <div class="grid grid-cols-6 gap-2">
                                <!-- Emojis will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-end">
                    <textarea id="messageInput" class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="2"></textarea>
                    <button id="sendMessageBtn" class="ml-2 bg-primary text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-primary/90 transition-custom">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var socket = io();
        var nickname = "{{ nickname }}";
        var messageContainer = document.getElementById('messageContainer');
        var messageInput = document.getElementById('messageInput');
        var sendBtn = document.getElementById('sendMessageBtn');
        var emojiBtn = document.getElementById('emojiBtn');
        var emojiPicker = document.getElementById('emojiPicker');
        var onlineCount = document.getElementById('onlineCount');
        var userList = document.getElementById('userList');
        var expectingAICount = 0;
        
        // Common Emoji List
        var emojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
            'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
            'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
            'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
            'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
            'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
            'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
            'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
            'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà',
            'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ',
            'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø',
            'üòæ', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û',
            'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç',
            'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù',
            'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶µ', 'ü¶ø', 'ü¶∂', 'üë£',
            'üëÄ', 'üëÅÔ∏è', 'üëÑ', 'üíã', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å',
            'ü¶∑', 'ü¶¥', 'üó£Ô∏è', 'üë§', 'üë•', 'ü´Ç'
        ];

        // Populate Emoji Picker
        var emojiGrid = emojiPicker.querySelector('.grid');
        emojis.forEach(emoji => {
            var btn = document.createElement('button');
            btn.className = "text-xl hover:bg-gray-100 p-1 rounded transition-custom";
            btn.textContent = emoji;
            btn.onclick = function() {
                insertText(emoji);
                emojiPicker.classList.add('hidden');
            };
            emojiGrid.appendChild(btn);
        });

        // Toggle Emoji Picker
        emojiBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            emojiPicker.classList.toggle('hidden');
        });

        // Close picker when clicking outside
        document.addEventListener('click', function(e) {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.classList.add('hidden');
            }
        });

        function scrollToBottom() {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function appendMessage(data, isSelf) {
            var div = document.createElement('div');
            div.className = isSelf ? "flex justify-end mb-4" : "flex justify-start mb-4";
            
            var avatarHtml = `<img alt="Avatar" class="w-8 h-8 rounded-full object-cover ${isSelf ? 'ml-2 mt-1 order-2' : 'mr-2 mt-1'}" src="/api/searchImage?query=${data.nickname}"/>`;
            
            var messageContent = '';
            if (data.type === 'video') {
                messageContent = `<iframe src="${data.msg}" class="w-[400px] h-[400px] border-0 rounded-lg bg-black" allowfullscreen></iframe>`;
            } else if (data.type === 'music') {
                var music = data.msg;
                messageContent = `
                    <div class="bg-white p-0 rounded-lg shadow-md w-64 overflow-hidden border border-gray-100">
                        <div class="relative h-48 bg-gray-200">
                             <img src="${music.image}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x300?text=No+Cover'"/>
                             <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-3">
                                 <div class="text-white">
                                     <h3 class="font-bold text-base truncate">${music.name}</h3>
                                     <p class="text-xs opacity-90 truncate">${music.singer}</p>
                                 </div>
                             </div>
                        </div>
                        <div class="p-3 bg-gray-50">
                            <audio controls class="w-full h-8" src="${music.url}">
                                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÂÖÉÁ¥†„ÄÇ
                            </audio>
                        </div>
                    </div>
                `;
            } else if (data.type === 'weather') {
                var w = data.msg;
                var loc = w.location_info;
                var wd = w.weather_data;
                var today = wd.forecast && wd.forecast.length > 0 ? wd.forecast[0] : {};
                
                // Determine background based on weather type (simple logic)
                var bgClass = "from-blue-400 to-blue-600"; // Default Sunny/Clear
                if (today.type && today.type.includes("Èõ®")) bgClass = "from-gray-700 to-blue-800";
                else if (today.type && today.type.includes("Èò¥")) bgClass = "from-gray-500 to-gray-700";
                else if (today.type && today.type.includes("Â§ö‰∫ë")) bgClass = "from-blue-300 to-gray-400";

                messageContent = `
                    <div class="bg-gradient-to-br ${bgClass} text-white rounded-lg p-4 w-64 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold">${loc.city}</h3>
                                <p class="text-xs opacity-80">${today.week || ''} ${today.date ? today.date + 'Êó•' : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold">${wd.wendu}¬∞</p>
                                <p class="text-sm font-medium">${today.type || ''}</p>
                            </div>
                        </div>
                        <div class="mt-4 space-y-1 text-sm opacity-95">
                            <div class="flex justify-between">
                                <span>üå°Ô∏è ${today.low || ''} ~ ${today.high || ''}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>üí® ${today.fx || ''} ${today.fl || ''}</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1 pt-1 border-t border-white/20">
                                <span>üíß ÊπøÂ∫¶ ${wd.shidu}</span>
                                <span class="bg-white/20 px-1 rounded text-[10px] leading-4">${wd.quality}</span>
                            </div>
                            <p class="mt-2 text-xs pt-2 border-t border-white/10 italic opacity-80">"${today.notice || ''}"</p>
                        </div>
                    </div>
                `;
            } else {
                messageContent = `<p>${data.msg}</p>`;
            }

            var contentHtml = `
                <div class="max-w-[70%] ${isSelf ? 'order-1' : ''}">
                    <div class="${isSelf ? 'bg-primary text-white rounded-tr-none' : 'bg-white rounded-tl-none'} rounded-lg p-3 shadow-sm overflow-hidden">
                        ${!isSelf ? `<p class="text-xs text-gray-400 mb-1">${data.nickname}</p>` : ''}
                        ${messageContent}
                    </div>
                    <span class="text-xs text-gray-400 ${isSelf ? 'mr-2 text-right' : 'ml-2'} block mt-1">${data.time}</span>
                </div>
            `;
            
            div.innerHTML = isSelf ? contentHtml + avatarHtml : avatarHtml + contentHtml;
            messageContainer.appendChild(div);
            scrollToBottom();
        }

        function appendSystemMessage(msg) {
            var div = document.createElement('div');
            div.className = "text-center my-4";
            div.innerHTML = `<span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded-full">${msg}</span>`;
            messageContainer.appendChild(div);
            scrollToBottom();
        }

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('receive_message', function(data) {
            appendMessage(data, data.nickname === nickname);

            // Trigger AI response if this is a confirmation of our @ÊàêÂ∞èÁêÜ message
            if (expectingAICount > 0 && data.nickname === nickname && data.msg.startsWith('@ÊàêÂ∞èÁêÜ')) {
                var prompt = data.msg.replace('@ÊàêÂ∞èÁêÜ', '').trim();
                if (prompt) {
                    expectingAICount--;
                    triggerAIResponse(prompt);
                }
            }
        });

        socket.on('system_message', function(data) {
            appendSystemMessage(data.msg);
        });

        socket.on('update_user_list', function(data) {
            onlineCount.textContent = data.count;
            userList.innerHTML = '';
            data.users.forEach(user => {
                var userItem = document.createElement('div');
                userItem.className = 'flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50';
                userItem.innerHTML = `
                    <img alt="Avatar" class="w-10 h-10 rounded-full object-cover" src="/api/searchImage?query=${user}"/>
                    <div class="ml-3 flex-1">
                        <h4 class="font-medium text-sm text-gray-700">${user}</h4>
                        <p class="text-xs text-green-500 flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>Âú®Á∫ø</p>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        });

        function appendAIMessage() {
            var div = document.createElement('div');
            div.className = "flex justify-start mb-4";
            
            var avatarHtml = `<img alt="Avatar" class="w-8 h-8 rounded-full object-cover mr-2 mt-1" src="/api/searchImage?query=ÊàêÂ∞èÁêÜ"/>`;
            
            var contentHtml = `
                <div class="max-w-[70%]">
                    <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm">
                        <p class="text-xs text-gray-400 mb-1">ÊàêÂ∞èÁêÜ (AI)</p>
                        <p class="ai-content typing-indicator">...</p>
                    </div>
                    <span class="text-xs text-gray-400 ml-2 block mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
            `;
            
            div.innerHTML = avatarHtml + contentHtml;
            messageContainer.appendChild(div);
            scrollToBottom();
            
            // Return the content element so we can update it
            return div.querySelector('.ai-content');
        }

        function triggerAIResponse(prompt) {
             var aiContentEl = appendAIMessage();
             aiContentEl.classList.remove('typing-indicator');
             aiContentEl.textContent = ''; // Clear "..."
             
             // Start SSE
             var eventSource = new EventSource('/api/ai_chat?prompt=' + encodeURIComponent(prompt));
             
             eventSource.onmessage = function(e) {
                 if (e.data === '[DONE]') {
                     eventSource.close();
                     return;
                 }
                 
                 try {
                     var data = JSON.parse(e.data);
                     if (data.content) {
                         aiContentEl.textContent += data.content;
                         scrollToBottom();
                     } else if (data.error) {
                         aiContentEl.textContent += "\n[Error: " + data.error + "]";
                         eventSource.close();
                     }
                 } catch (err) {
                     console.error('Error parsing SSE data', err);
                 }
             };
             
             eventSource.onerror = function(e) {
                 console.error('SSE Error', e);
                 eventSource.close();
                 // If empty, maybe show error
                 if (aiContentEl.textContent === '') {
                     aiContentEl.textContent = "ËøûÊé•AIÊúçÂä°Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ";
                 }
             };
        }

        function sendMessage() {
            var msg = messageInput.value.trim();
            if (msg) {
                socket.emit('send_message', {msg: msg});
                
                // Check if message starts with @ÊàêÂ∞èÁêÜ
                if (msg.startsWith('@ÊàêÂ∞èÁêÜ')) {
                    var prompt = msg.replace('@ÊàêÂ∞èÁêÜ', '').trim();
                    if (prompt) {
                        expectingAICount++;
                    }
                }
                messageInput.value = '';
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.insertText = function(text) {
            messageInput.value += text;
            messageInput.focus();
        }
    </script>
</body>
</html>
